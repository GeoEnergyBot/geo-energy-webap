
# GeoEnergyBot ‚Äî –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç ‚Äî –±—Ä–∞—É–∑–µ—Ä–Ω–∞—è –∏–≥—Ä–∞ —Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π (Leaflet), —Å–µ—Ä–≤–µ—Ä–æ–º Supabase (Players + Edge Function –¥–ª—è —Ç–æ—á–µ–∫ —ç–Ω–µ—Ä–≥–∏–∏) –∏ –º–∏–Ω–∏‚Äë–∏–≥—Ä–æ–π –ø—Å–µ–≤–¥–æ‚ÄëAR (¬´–ì–∏—Ä–æ—Å–∫–æ–ø–Ω–∞—è –ø–æ–≥–æ–Ω—è¬ª) –ø–æ–≤–µ—Ä—Ö –∫–∞–º–µ—Ä—ã.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

```
main.js
src/
  env.js
  utils.js
  ui.js
  api/
    supabase.js
  ar/
    gyroChase.js
  map/
    tiles.js
    energy.js
```

### `main.js` ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º** –º–æ–¥—É–ª–µ–º –∏–∑ `index.html` (`<script type="module" src="main.js">`).
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Telegram WebApp, Supabase, –∑–∞–≥—Ä—É–∂–∞–µ—Ç/—Å–æ–∑–¥–∞—ë—Ç –∏–≥—Ä–æ–∫–∞.
- –°—Ç—Ä–æ–∏—Ç –∫–∞—Ä—Ç—É Leaflet (–±–∞–∑–æ–≤—ã–µ —Å–ª–æ–∏ —á–µ—Ä–µ–∑ `buildBaseLayers()`).
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é, –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç —Ç–æ—á–∫–∏ —ç–Ω–µ—Ä–≥–∏–∏ (`loadEnergyPoints()`).
- –°–æ–∑–¥–∞—ë—Ç AR‚Äë—Ç–æ—á–∫—É —Ä—è–¥–æ–º —Å –∏–≥—Ä–æ–∫–æ–º –∏ –≤–µ—à–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—É—Å–∫–∞ –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã `openGyroChase()`.

### `src/env.js` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏/–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
- `SUPABASE_URL`, `SUPABASE_ANON` ‚Äî –∫–ª—é—á–∏ –∏ URL –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ Supabase (**–∞–Ω–æ–Ω–∏–º–Ω—ã–π –∫–ª—é—á; –∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö**).
- `FUNCTIONS_ENDPOINT` ‚Äî URL Edge‚Äë—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏/—Å–±–æ—Ä–∞ —Ç–æ—á–µ–∫.
- `DIFFICULTY` ‚Äî –ø—Ä–æ—Ñ–∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã (—Ä–∞–¥–∏—É—Å –ø—Ä–∏—Ü–µ–ª–∞, —Å–∫–æ—Ä–æ—Å—Ç—å, –≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è).
- `AR_TUNING` ‚Äî ¬´—Ñ–∏–∑–∏–∫–∞¬ª –∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≥–∏—Ä–æ—Å–∫–æ–ø–∞/–¥–∂–æ–π—Å—Ç–∏–∫–∞.
- `GHOST_ICON_BASES` ‚Äî –º–∞—Å—Å–∏–≤ –±–∞–∑–æ–≤—ã—Ö –ø—É—Ç–µ–π –¥–æ —Å–ø—Ä–∞–π—Ç–æ–≤ –ø—Ä–∏–∑—Ä–∞–∫–∞; –∫–æ–¥ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø–æ–ø—Ä–æ–±—É–µ—Ç –∏—Ö –ø–æ –æ—á–µ—Ä–µ–¥–∏ (—É–¥–æ–±–Ω–æ, –µ—Å–ª–∏ –∞—Å—Å–µ—Ç—ã —É –≤–∞—Å –ª–µ–∂–∞—Ç –≤ `ghost_icons/` –∏–ª–∏ `assets/ghosts/`).

### `src/utils.js` ‚Äî —É—Ç–∏–ª–∏—Ç—ã
- –ì–µ–æ‚Äë—Ñ—É–Ω–∫—Ü–∏–∏ (`getDistanceKm`, `getTileId`) –∏ –∏–∫–æ–Ω–∫–∏:
  - `resolveGhostUrl(level)` ‚Äî **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è** –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–ø—Ä–∞–π—Ç–∞ –ø—Ä–∏–∑—Ä–∞–∫–∞ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø—É—Ç—è–º (–∏–∑ `GHOST_ICON_BASES`).
  - `makeLeafletGhostIconAsync(level)` ‚Äî —Å–æ–∑–¥–∞—ë—Ç `L.icon` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ URL.
- –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ –∏–∫–æ–Ω–∫–∏ (`getEnergyIcon(type)`).

### `src/ui.js` ‚Äî —Ä–∞–±–æ—Ç–∞ —Å UI
- `updatePlayerHeader({...})` ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–º—è, —É—Ä–æ–≤–µ–Ω—å, –ø—Ä–æ–≥—Ä–µ—Å—Å —ç–Ω–µ—Ä–≥–æ‚Äë–ø–æ–ª–æ—Å–∫–∏ –∏ **–∞–≤–∞—Ç–∞—Ä –ø—Ä–∏–∑—Ä–∞–∫–∞** –≤ —à–∞–ø–∫–µ. –ê–≤–∞—Ç–∞—Ä –±–µ—Ä—ë—Ç—Å—è —á–µ—Ä–µ–∑ `resolveGhostUrl()` —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Ñ–æ–ª–±—ç–∫–æ–º.
- `flashPlayerMarker(marker)` ‚Äî –∫—Ä–∞—Ç–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ –∏–≥—Ä–æ–∫–∞ –ø–æ—Å–ª–µ —Å–æ–±—ã—Ç–∏–π (—Å–±–æ—Ä/–ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è).

### `src/api/supabase.js` ‚Äî –¥–æ—Å—Ç—É–ø –∫ –ë–î
- `initSupabase()` ‚Äî –ª–µ–Ω–∏–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ Supabase.
- `loadOrCreatePlayer(user)` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–∞ –ø–æ `telegram_id` –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏; –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å/—ç–Ω–µ—Ä–≥–∏—é/–ª–∏–º–∏—Ç –∏ —Å–∞–º—É —Å—Ç—Ä–æ–∫—É.

### `src/ar/gyroChase.js` ‚Äî –º–∏–Ω–∏‚Äë–∏–≥—Ä–∞ ¬´–ì–∏—Ä–æ—Å–∫–æ–ø–Ω–∞—è –ø–æ–≥–æ–Ω—è¬ª
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –∫–∞–º–µ—Ä—ã (`getUserMedia`), —Ä–∏—Å—É–µ—Ç—Å—è –æ–≤–µ—Ä–ª–µ–π (–ø—Ä–∏—Ü–µ–ª, –ø—Ä–æ–≥—Ä–µ—Å—Å‚Äë–∫–æ–ª—å—Ü–æ, –ø—Ä–∏–∑—Ä–∞–∫, —Å—Ç—Ä–µ–ª–∫–∏).
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
  - `DeviceOrientation` (iOS ‚Äî —á–µ—Ä–µ–∑ `requestPermission()`).
  - –§–æ–ª–±—ç–∫: –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ (—Ç–∞—á) —Å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏–∑ `AR_TUNING`.
- –õ–æ–≥–∏–∫–∞:
  - –ü—Ä–∏–∑—Ä–∞–∫ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ ¬´—É–±–µ–≥–∞–µ—Ç¬ª –∫ –∫—Ä–∞—é —ç–∫—Ä–∞–Ω–∞; –∏–Ω–æ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç ¬´—Ñ–∏–Ω—Ç—ã¬ª.
  - –ò–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –ø–æ–≤–µ—Ä–Ω—É—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω —Ç–∞–∫, —á—Ç–æ–±—ã –ø—Ä–∏–∑—Ä–∞–∫ –æ–∫–∞–∑–∞–ª—Å—è –≤–Ω—É—Ç—Ä–∏ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –∫—Ä—É–≥–∞ –∏ —É–¥–µ—Ä–∂–∞—Ç—å –µ–≥–æ **N –º—Å**.
  - –ü—Ä–∏ —É—Å–ø–µ—Ö–µ ‚Äî –≤–∏–±—Ä–æ/–∑–≤—É–∫ –∏ `alert('–ü–æ–∫–µ–º–æ–Ω –ø–æ–π–º–∞–Ω')`.

### `src/map/tiles.js` ‚Äî –∫–∞—Ä—Ç–∞ –∏ AR‚Äë–≤—Ö–æ–¥
- `buildBaseLayers()` ‚Äî Carto Dark, OSM, Esri Satellite.
- `spawnArEntryNear(map, lat, lng)` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –º–∞—Ä–∫–µ—Ä üëæ —Ä—è–¥–æ–º —Å –∏–≥—Ä–æ–∫–æ–º (‚âà15 –º).
- `setArEntryHandler(marker, playerMarker)` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∏—Å—Ç–∞–Ω—Ü–∏—é ‚â§ 20 –º –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `openGyroChase()`.

### `src/map/energy.js` ‚Äî —Ç–æ—á–∫–∏ —ç–Ω–µ—Ä–≥–∏–∏
- `loadEnergyPoints(map, playerMarker, user)` ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç Edge‚Äë—Ñ—É–Ω–∫—Ü–∏—é:
  - `action: "generate"` ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–∫–∏.
  - `action: "collect"` ‚Äî —Å–æ–±—Ä–∞—Ç—å —Ç–æ—á–∫—É (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ ‚â§ 20 –º).
- –ò–∫–æ–Ω–∫–∏ —Ç–æ—á–µ–∫ ‚Äî –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ `energy_blobs/` (`normal_blob.png`, `advanced_blob.png`, `rare_blob.png`).
- –ü–æ—Å–ª–µ —Å–±–æ—Ä–∞:
  - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞–ø–∫–∏ –∏–≥—Ä–æ–∫–∞,
  - —Å–º–µ–Ω–∞ –∏–∫–æ–Ω–∫–∏ –º–∞—Ä–∫–µ—Ä–∞ –∏–≥—Ä–æ–∫–∞ –Ω–∞ **–∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–∫–∏–Ω —É—Ä–æ–≤–Ω—è**,
  - –∞–ª–µ—Ä—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–Ω–µ—Ä–≥–∏–∏.

## –ì–¥–µ –ª–µ–∂–∞—Ç –∞—Å—Å–µ—Ç—ã

- **–ò–∫–æ–Ω–∫–∏ –ø—Ä–∏–∑—Ä–∞–∫–æ–≤**: –ø–æ–ª–æ–∂–∏—Ç–µ –≤ **–æ–¥–∏–Ω –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–æ–≤**:
  - `ghost_icons/ghost_001.png ‚Ä¶ ghost_100.png`  
  - **–∏–ª–∏** `assets/ghosts/ghost_001.png ‚Ä¶ ghost_100.png`
- –ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ; –∫–æ–¥ —Å–∞–º –ø–æ–¥–±–µ—Ä—ë—Ç –ø—É—Ç—å.
- –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞–ø–ª–∏: `energy_blobs/normal_blob.png`, `advanced_blob.png`, `rare_blob.png`
- –ó–≤—É–∫: –≤ DOM –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `<audio id="energy-sound" src="sounds/collect.mp3" preload="auto"></audio>`

## –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

**–ê–≤–∞—Ç–∞—Ä—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è**  
–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —Å–ø—Ä–∞–π—Ç—ã –ª–µ–∂–∞—Ç –Ω–µ –≤ —Ç–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ. –ú—ã –¥–æ–±–∞–≤–∏–ª–∏ —É–º–Ω—ã–π —Ñ–æ–ª–±—ç–∫: –º–æ–¥—É–ª—å —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç `ghost_icons/`, –∑–∞—Ç–µ–º `assets/ghosts/`. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã –Ω–∞–∑–≤–∞–Ω—ã —Å—Ç—Ä–æ–≥–æ –ø–æ —à–∞–±–ª–æ–Ω—É: `ghost_001.png`, `ghost_002.png`, ... `ghost_100.png`.

**AR –Ω–µ –∫—Ä—É—Ç–∏—Ç—Å—è –Ω–∞ iOS**  
–ù—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –¥–∞—Ç—á–∏–∫–∏: –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ ¬´–í–∫–ª—é—á–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ¬ª. –ù–∞–∂–º–∏—Ç–µ –µ—ë.

**–ö–∞–º–µ—Ä–∞ —á—ë—Ä–Ω–∞—è**  
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ Telegram/–±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –∫–∞–º–µ—Ä—É. –ü—Ä–∏ –æ—à–∏–±–∫–µ –±—É–¥–µ—Ç –∞–ª–µ—Ä—Ç.

## –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å
–ü—Ä–∞–≤—å—Ç–µ `src/env.js`:
```js
export const DIFFICULTY = {
  common:   { reticleRadiusPx: 50, holdMs: 1200, baseSpeed: 200, nearBoost: 100 },
  advanced: { reticleRadiusPx: 45, holdMs: 1600, baseSpeed: 240, nearBoost: 120 },
  rare:     { reticleRadiusPx: 38, holdMs: 2200, baseSpeed: 280, nearBoost: 140 },
};
```

–ò–ª–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–∞—Ç—á–∏–∫–æ–≤:
```js
export const AR_TUNING = {
  sensorYawToPx: 6,
  sensorPitchToPx: 6,
  joystickSensitivity: 1.6,
};
```

–£–¥–∞—á–∏!
